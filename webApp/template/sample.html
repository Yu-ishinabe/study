<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="../css/style.css?{{.Time.Format "2006/1/2 15:04:05"}}" type="text/css">
  <title>TITLE</title>
</head>
<body>
  <h1>{{.Message}}</h1>
  <p>アクセスした時刻： {{.Time.Format "2006/1/2 15:04:05"}}</p>
  <div id="container">
    <canvas id="mainCanvas"></canvas>
    <table id="controlPanel">
      <tr>
        <td>
          開始地点：
          <select id="startVertex">
            <option value=""></option>
          </select>
        </td>
        <td>
          終了地点：
          <select id="endVertex">
            <option value=""></option>
          </select>
        </td>
      </tr>
      <tr>
        <td colspan="2">
          <button id="calcBtn">最短経路算出</button>
        </td>
      </tr>
    </table>
  </div>

  <script>
    var CANVAS_WIDTH = 800;
    var CANVAS_HEIGHT = 400;
    var VERTEX_SIZE = 30;
    var ctx = null;
    var vertexes = [];
    var paths = [];
    var selectVertexFrom = null;
    var selectVertexTo = null;
    var startVertex = null;
    var endVertex = null;

    function Vertex(px, py) {
      this.px = px;
      this.py = py;
    }

    function Path(from, to, dist) {
      this.from = from;
      this.to = to;
      this.dist = dist;
    }

    function draw() {
      for (var i = 0; i < vertexes.length; i++) {
        var v = vertexes[i];
        drawVertex(v.px, v.py, i)
      }
      for (var i = 0; i < paths.length; i++) {
        var p = paths[i];
        drawPath(p.from, p.to, p.dist);
      }
    }

    function drawVertex(x, y, id) {
      if (id === selectVertexFrom) {
        ctx.strokeStyle = 'blue';
      } else if (id === startVertex) {
        ctx.strokeStyle = 'green';
      } else if (id === endVertex) {
        ctx.strokeStyle = 'red';
      } else {
        ctx.strokeStyle = 'black';
      }
      ctx.lineWidth = 5;
      ctx.strokeRect(x, y, VERTEX_SIZE, VERTEX_SIZE);
      ctx.font = "20px 'ＭＳ ゴシック'";
      ctx.textAlign = 'center';
      ctx.fillText(id, x + VERTEX_SIZE/2, y + VERTEX_SIZE/2 + 10)
    }

    function drawPath(from, to, dist) {
      var vertexFrom = vertexes[from];
      var vertexTo = vertexes[to];
      var sx = vertexFrom.px + VERTEX_SIZE/2;
      var sy = vertexFrom.py + VERTEX_SIZE/2;
      var ex = vertexTo.px + VERTEX_SIZE/2;
      var ey = vertexTo.py + VERTEX_SIZE/2
      ctx.strokeStyle = 'rgb(0,0,0)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(sx, sy);
      ctx.lineTo(ex, ey);
      ctx.stroke();
      ctx.font = "20px 'ＭＳ ゴシック'";
      ctx.textAlign = 'center';
      ctx.fillText(dist, sx+(ex-sx)/2 + 10, sy+(ey-sy)/2-10)
    }

    function clickCanvas(e) {
      var rect = e.target.getBoundingClientRect();
      mx = e.clientX - Math.floor(rect.left);
      my = e.clientY - Math.floor(rect.top);

      var isSelect = false;
      for (var i = 0; i < vertexes.length; i++) {
        var v = vertexes[i];
        if (mx >= v.px && mx <= v.px + VERTEX_SIZE && my >= v.py && my <= v.py + VERTEX_SIZE) {
          isSelect = true;
          if (selectVertexFrom === null) {
            selectVertexFrom = i;
          } else if (selectVertexFrom === i) {
            selectVertexFrom = null;
          } else {
            selectVertexTo = i;
            var dist = window.prompt('頂点' + selectVertexFrom + '〜頂点' + selectVertexTo + 'の距離を入力してください', '');
            if (dist !== null && dist  !== '') {
              paths.push(new Path(selectVertexFrom, selectVertexTo, parseInt(dist)));
              paths.push(new Path(selectVertexTo, selectVertexFrom, parseInt(dist)));
              selectVertexTo = selectVertexFrom = null;
            }
          }
          draw();
          break;
        }
      }
      if (!isSelect) {
        var id = vertexes.length;
        drawVertex(mx, my, id);

        var selectStartVertex = document.createElement('option');
        selectStartVertex.text = '頂点' + id;
        selectStartVertex.value = id;
        document.getElementById('startVertex').appendChild(selectStartVertex);

        var endStartVertex = document.createElement('option');
        endStartVertex.text = '頂点' + id;
        endStartVertex.value = id;
        document.getElementById('endVertex').appendChild(endStartVertex);
        vertexes.push(new Vertex(mx, my));
      }

    }

    function changeStartVertex() {
      var selectStartVertex = document.getElementById('startVertex');
      var index = selectStartVertex.selectedIndex;
      if (index !== 0) {
        startVertex = parseInt(selectStartVertex.options[index].value);
        draw();
      }
    }

      function changeEndVertex() {
        var selectEndVertex = document.getElementById('endVertex');
        var index = selectEndVertex.selectedIndex;
        if (index !== 0) {
          endVertex = parseInt(selectEndVertex.options[index].value);
          draw();
        }
      }

      function calc() {
        if (startVertex === null) {
          alert('開始地点が選択されていません');
        } else if (endVertex === null) {
          alert('終了地点が選択されていません');
        } else {
          var xhr = new XMLHttpRequest();
          xhr.open('POST', '/sample');
          xhr.setRequestHeader('Content-Type', 'application/json');
        }

        var data = {
          num: vertexes.length,
          paths: paths,
          start: startVertex,
          end: endVertex
        };
        console.log(data);
        xhr.send(JSON.stringify(data));
      }

    window.onload = function () {
      canvas = document.getElementById('mainCanvas');
      canvas.width = CANVAS_WIDTH;
      canvas.height = CANVAS_HEIGHT;
      ctx = canvas.getContext('2d');
      canvas.addEventListener('click', clickCanvas, false);

      var selectStartVertex = document.getElementById('startVertex');
      selectStartVertex.onchange = changeStartVertex;
      var selectEndVertex = document.getElementById('endVertex');
      selectEndVertex.onchange = changeEndVertex;

      document.getElementById('calcBtn').onclick = calc;
    }
  </script>
</body>
</html>
